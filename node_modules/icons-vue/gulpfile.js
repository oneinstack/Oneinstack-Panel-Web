const gulp = require("gulp");
const clean = require('gulp-clean')
const ts = require('gulp-typescript')
const uglify = require('gulp-uglify')
const browserify = require("browserify")
const tsify = require("tsify")
const buffer = require('vinyl-buffer')
const source = require('vinyl-source-stream')


// 清理dist目录
gulp.task('clean', function () {
  return gulp.src('dist', {
    read: false, 
    // 允许清除的目录不存在
    allowEmpty: true
  }).pipe(clean('dist'))
})

// 生成 declare 文件
gulp.task('tsc', function () {
  return gulp.src(['./*.ts', './!(node_modules)/*.ts']).pipe(ts({
    declaration: true
  })).pipe(gulp.dest('lib'))
})

// 清除多余js文件
// gulp.task('clean-js', function () {
//   return gulp.src('dist/**/*.js', {read: false}).pipe(clean('*.js'))
// })

gulp.task('build', function() {
  return browserify({
    basedir: '.',
    debug: true,
    entries: ['index.ts'],
    cache: {},
    packageCache: {}
  }).plugin(tsify).bundle().pipe(source('index.js')).pipe(buffer()).pipe(uglify()).pipe(gulp.dest('dist'))
})


// 复制代码
gulp.task('default', gulp.series(
  gulp.parallel('clean'), 
  gulp.parallel('tsc'), 
  // gulp.parallel('clean-js'),
  gulp.parallel('build')
  )
)
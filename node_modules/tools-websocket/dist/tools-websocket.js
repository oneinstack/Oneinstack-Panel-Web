!function(){"use strict";function t(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function a(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}h((i=i.apply(t,e||[])).next())}))}var e;"function"==typeof SuppressedError&&SuppressedError,function(t){t[t.load=0]="load",t[t.open=1]="open",t[t.close=2]="close"}(e||(e={}));class s{constructor(t){var e,s,i,n,o;this.failNum=0,this.timer=null,this.start=()=>{this.status&&null===this.timer&&(this.failNum=0,this.timer=setInterval((()=>{if(this.failNum>=this.heartFailNum)return this.stop(),void this.websocketbean.onerror();let t=this.heartSend;"function"==typeof this.heartSend&&(t=this.heartSend(this.websocketbean.param)),this.websocketbean.websocket.send(t),this.failNum++}),this.heartGapTime))},this.stop=()=>{this.status&&(clearInterval(this.timer),this.timer=null)},this.onmessage=t=>{var e,s;if(this.status)if("string"==typeof this.heartGet){const i=null!==(e=this.websocketbean.param.messagePrefix)&&void 0!==e?e:"",n=null!==(s=this.websocketbean.param.messageSuffix)&&void 0!==s?s:"";t===i+this.heartGet+n&&(this.failNum=0)}else"function"==typeof this.heartGet&&this.heartGet(this.websocketbean.param,t)&&(this.failNum=0)},this.websocketbean=t,this.status=null!==(e=t.param.needHeart)&&void 0!==e&&e,this.heartSend=null!==(s=this.websocketbean.param.heartSend)&&void 0!==s?s:"heartSend",this.heartGet=null!==(i=this.websocketbean.param.heartGet)&&void 0!==i?i:"heartGet",this.heartGapTime=null!==(n=this.websocketbean.param.heartGapTime)&&void 0!==n?n:3e4,this.heartFailNum=null!==(o=this.websocketbean.param.heartFailNum)&&void 0!==o?o:10}}class i{constructor(t){var e,s,i;this.num=0,this.reconnectMaxNum=10,this.reconnectGapTime=3e4,this.timer=null,this.start=()=>{this.status&&null===this.timer&&(this.num=0,this.websocketbean.param.onreconnect&&this.websocketbean.param.onreconnect(),this.timer=setInterval((()=>{if(this.num>=this.reconnectMaxNum)return this.websocketbean.param.onFailReconnect&&this.websocketbean.param.onFailReconnect(),void this.stop();this.websocketbean.start(),this.num++}),this.reconnectGapTime))},this.stop=()=>{this.status&&(clearInterval(this.timer),this.timer=null)},this.websocketbean=t,this.status=null!==(e=t.param.needReconnect)&&void 0!==e&&e,this.reconnectMaxNum=null!==(s=this.websocketbean.param.reconnectMaxNum)&&void 0!==s?s:10,this.reconnectGapTime=null!==(i=this.websocketbean.param.reconnectGapTime)&&void 0!==i?i:3e4}}const n={WebSocketBean:class{constructor(n){this.status=null,this.websocket=null,this.heart=null,this.reconnect=null,this.onopen=()=>t(this,void 0,void 0,(function*(){this.reconnect.stop(),this.param.onopen&&this.param.onopen(),this.status=e.open,this.heart.start()})),this.onmessage=t=>{this.param.onmessage&&this.param.onmessage(t),this.heart.onmessage(t.data)},this.onerror=()=>{this.param.onerror&&this.param.onerror(),this.close(),"hidden"!=document.visibilityState?this.reconnect.start():this.hiddenReconnect=!0},this.start=t=>{this.close(),t?this.param=t:t=this.param,this.websocket=new WebSocket(t.url),t.binaryType||(t.binaryType="blob"),this.websocket.binaryType=t.binaryType,this.status=e.load,this.websocket.onopen=this.onopen,this.websocket.onmessage=this.onmessage,this.websocket.onerror=this.onerror,this.websocket.onclose=this.onerror,this.heart=new s(this),null===this.reconnect&&(this.reconnect=new i(this)),window.addEventListener("beforeunload",this.dispose)},this.hiddenReconnectVisibility=()=>{"hidden"!=document.visibilityState&&this.hiddenReconnect&&(this.hiddenReconnect=!1,this.reconnect.start())},this.hiddenReconnect=!1,this.send=e=>t(this,void 0,void 0,(function*(){const s=this.param.sendPrefix,i=this.param.sendSuffix;if(!s&&!i)return void this.websocket.send(e);const n=yield function(e){return t(this,void 0,void 0,(function*(){if(null==e)return{type:"string",data:e+"",str:e};if("string"==typeof e)return{type:"string",data:e,str:e};if(e instanceof Blob)return new Promise(((t,s)=>{const i=new FileReader;i.onloadend=()=>t({type:"blob",data:e,str:i.result}),i.onerror=s,i.readAsText(e)}));if(e instanceof ArrayBuffer){const t=new TextDecoder("utf-8");return{type:"arraybuffer",data:e,str:t.decode(new Uint8Array(e))}}if("object"==typeof e||Array.isArray(e)){const t=JSON.stringify(e,((t,e)=>{if("function"!=typeof e&&void 0!==e)return e}));return{type:"object",data:e,str:t}}throw new Error("Unsupported data type")}))}(e),o=yield function(e,s,i,n){return t(this,void 0,void 0,(function*(){const t=`${i||""}${e}${n||""}`;return"blob"===s?new Blob([t],{type:"text/plain"}):"arraybuffer"===s?(new TextEncoder).encode(t).buffer:e}))}(n.str,n.type,this.param.sendPrefix,this.param.sendSuffix);this.websocket.send(o)})),this.close=()=>{null!==this.websocket&&(window.removeEventListener("beforeunload",this.dispose),this.websocket&&(this.websocket.onerror=null,this.websocket.onmessage=null,this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.close(),this.websocket=null),this.heart&&(this.heart.stop(),this.heart=null),this.status=e.close)},this.dispose=()=>{this.close(),this.reconnect&&(this.reconnect.stop(),this.reconnect=null),document.removeEventListener("visibilitychange",this.hiddenReconnectVisibility)},this.param=n,document.addEventListener("visibilitychange",this.hiddenReconnectVisibility)}}};Object.keys(n).forEach((t=>{window[t]=n[t]}))}();

<template>
    <div
        style="display: inline-flex"
        :style="
            Object.assign(styles, {
                'background-image': 'url(' + conf.content + ')',
                'background-size': '100% 100%',
                width: (width ? conf.props.width : conf.props.size) + conf.props.unit,
                height: (height ? conf.props.height : conf.props.size) + conf.props.unit
            })
        "
        :class="classs"
    ></div>
</template>

<script lang="ts" setup>
import { reactive, watch } from 'vue'

const props = defineProps({
    /**
     * 加载静态资源地址，默认为https://luoye6.c44.cc/vsicon
     */
    url: { default: '' },
    /**
     * 使用的图标库名称，默认为''
     */
    lib: { default: '' },
    /**
     * 使用的图标名称，默认为'up'
     */
    name: { default: '' },
    /**
     * 使用的图标大小，默认为'20'
     */
    size: { default: '' as any },
    /**
     * 图标大小-宽
     */
    width: { default: undefined as any },
    /**
     * 图标大小-高
     */
    height: { default: undefined as any },
    /**
     * 使用的图标颜色，默认为[]
     */
    color: { default: [] as string[] },
    /**
     * 样式
     */
    styles: { default: {} as any },
    /**
     * 样式
     */
    classs: { default: '' },
    /**
     * 图标宽高显示单位，默认为px
     */
    unit: { default: '' }
})

const viconConf = VConf.vsicon

const svgToUrl = (url: any) => {
    var encoded = url
        .replace(/<!--(.*)-->/g, '')
        .replace(/[\r\n]/g, ' ')
        .replace(/"/g, `'`)
        .replace(/%/g, '%25')
        .replace(/&/g, '%26')
        .replace(/#/g, '%23')
        .replace(/{/g, '%7B')
        .replace(/}/g, '%7D')
        .replace(/</g, '%3C')
        .replace(/>/g, '%3E')
    let res = '"' + `data:image/svg+xml,${encoded}` + '"'
    return res
}

const colorTag = ['stop-color', 'fill', 'stroke']
const replaceColor = (str: any, colorStr: any, _color: any) => {
    for (let i = 0; i < colorTag.length; i++) {
        const _tag = colorTag[i]
        str = str.replace(new RegExp(`${_tag}="${colorStr}"`, 'g'), `${_tag}="${_color}"`)
    }
    return str
}

const conf = reactive({
    props: {
        url: '',
        lib: '',
        name: '',
        size: '' as any,
        width: undefined as any,
        height: undefined as any,
        color: [] as string[],
        styles: {} as any,
        classs: '',
        unit: 'px'
    },
    getProps: () => {
        Object.keys(conf.props).forEach((key) => {
            //@ts-ignore
            if (!StrUtil.isNull(viconConf[key])) {
                //@ts-ignore
                conf.props[key] = viconConf[key]
            }
            //@ts-ignore
            if (!StrUtil.isNull(props[key])) {
                //@ts-ignore
                conf.props[key] = props[key]
            }
        })
    },
    content: '',
    colorsObj: {} as any,
    init: async () => {
        conf.getProps()

        let color = conf.props.color

        if (StrUtil.isNull(conf.props.name)) return
        const _url = `${conf.props.url?.length ? conf.props.url : ''}/${
            conf.props.lib?.length ? conf.props.lib + '/' : ''
        }${conf.props.name}.svg`
        let filestr: any

        let _icon_resource = await viconConf.fun.getRes(_url)
        if (_icon_resource) {
            filestr = _icon_resource
        } else {
            filestr = await viconConf.fun.getResorce(_url, true)
        }

        let colors = []
        if (conf.colorsObj[conf.props.name]) {
            colors = conf.colorsObj[conf.props.name]
        } else {
            const colorRegex = /(?:stop-color|fill|stroke)="(#?\w+)"/g
            let match
            while ((match = colorRegex.exec(filestr)) !== null) {
                colors.push(match[1])
            }
            colors = colors.filter((v) => v !== 'none' && v.length > 0)
            colors = [...new Set(colors)]
            // console.log('colors',colors);
            conf.colorsObj[conf.props.name] = colors
        }
        for (let i = 0; i < colors.length; i++) {
            const colorStr = colors[i]
            const _color = color[i]
            if (_color) {
                filestr = replaceColor(filestr, colorStr, _color)
            }
        }

        conf.content = svgToUrl(filestr)
    }
})

watch(
    () => [props.name, props.lib, props.color],
    () => {
        conf.init()
    }
)

conf.init()
</script>

<template>
    <div class="v-select" @click="conf.dialog.open" ref="inputRef">
        <div style="width: calc(100% - 18px)">
            <input
                v-model="conf.input.label"
                type="text"
                :readonly="conf.input.readonly"
                :autocomplete="conf.input.autocomplete"
                :placeholder="placeholder"
            />
        </div>
        <div
            style="display: inline-flex; transition: all 0.3s"
            :style="{ transform: conf.dialog.show ? 'rotateZ(90deg)' : '' }"
        >
            <VIcon type="right" color="currentColor" />
        </div>
        <transition :name="conf.dialog.transition">
            <div class="v-select-dialog" v-show="conf.dialog.show" @click.stop="" ref="dialogRef">
                <div
                    class="v-select-dialog-arrows"
                    :class="[conf.dialog.transition === 'fade-up' ? 'down' : 'up']"
                ></div>
                <div :style="{ maxHeight: conf.dialog.position.maxHeight + 'px' }" style="overflow-y: auto">
                    <template v-for="item in list">
                        <div
                            class="v-select-dialog-item"
                            :class="[conf.activeItem.value === item.value ? 'selected' : '']"
                            @click.stop="conf.dialog.click(item)"
                        >
                            {{ item.label }}
                        </div>
                    </template>
                </div>
            </div>
        </transition>
    </div>
</template>

<script lang="ts" setup>
import { Scope } from 'tools-vue3'
import { onMounted, onUnmounted, reactive, ref, watch } from 'vue'
type Item = { label: string; value: any }
const props = defineProps({
    list: { default: [] as Item[] },
    active: { default: '' as any },
    placeholder: { default: '请选择' },
    /**
     * 可输入进行过滤
     */
    filterable: { default: null as any }
})

const emit = defineEmits(['update:active', 'change'])

const dialogRef = ref({} as HTMLDivElement)
const inputRef = ref({} as HTMLDivElement)

const timer = Scope.Timer()

const conf = reactive({
    activeItem: { value: '', label: '' } as Item,
    timer: null as any,
    input: {
        /**
         * 初始化选项
         */
        initValue: () => {
            const _item = props.list.find((item) => item.value === props.active)
            if (_item) {
                if (conf.activeItem.value !== _item.value) {
                    conf.activeItem = _item
                    conf.input.setValue(_item)
                }
            }
        },
        label: '',
        setValue: (item?: Item) => {
            const bvalue = conf.activeItem.value

            //默认内容和点击列表处理
            if (props.filterable === null || item) {
                if (item?.label) {
                    conf.activeItem = item
                    const _item = props.list.find((item) => item.value === conf.activeItem.value)
                    conf.input.label = _item ? _item.label : ''
                }
            }
            //处理过滤模式下输入的内容
            else {
                const _item = props.list.find((item) => item.value === conf.input.label)
                if (_item) {
                    conf.activeItem = _item
                    conf.input.label = _item.label
                } else {
                    conf.input.label = conf.activeItem.label
                }
            }
            emit('update:active', conf.activeItem.value)
            if (bvalue !== conf.activeItem.value) {
                emit('change', conf.activeItem)
            }
        },
        readonly: props.filterable == null,
        autocomplete: 'off'
    },
    dialog: {
        show: false,
        transition: 'fade-up',
        position: {
            maxHeight: 274
        },
        click: (item: Item) => {
            conf.dialog.close(item)
        },
        closeFun: () => {},
        close: (item?: any) => {
            conf.dialog.show = false
            conf.dialog.closeFun()

            conf.input.readonly = true

            conf.input.setValue(item)
        },
        open: () => {
            conf.dialog.closeFun()
            if (conf.dialog.show) {
                conf.dialog.close()
                return
            }
            conf.dialog.show = true

            //处理过滤器
            conf.input.readonly = props.filterable == null

            Timer.once(() => {
                conf.dialog.closeFun = DomUtil.listener(window, 'click', conf.dialog.close).remove
            }, 10)
        }
    }
})

watch(
    () => props.active,
    () => conf.input.initValue()
)

onMounted(() => {
    conf.input.initValue()
    conf.timer = Timer.on(() => {
        if (!conf.dialog.show) return
        if (inputRef.value?.getBoundingClientRect) {
            const inputrect = inputRef.value.getBoundingClientRect()
            if (dialogRef.value?.getBoundingClientRect) {
                const rect = dialogRef.value.getBoundingClientRect()
                if (inputrect.top + inputrect.height + rect.height > document.body.clientHeight) {
                    dialogRef.value.style.top = ''
                    dialogRef.value.style.bottom = inputrect.height + 10 + 'px'
                    conf.dialog.transition = 'fade-down'
                } else {
                    dialogRef.value.style.top = inputrect.height + 10 + 'px'
                    dialogRef.value.style.bottom = ''
                    conf.dialog.transition = 'fade-up'
                }
            }
        }
    }, 10)
})

onUnmounted(() => {
    Timer.un(conf.timer)
})
</script>

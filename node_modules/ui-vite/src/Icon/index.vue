<template>
    <div
        ref="iconRef"
        style="display: inline-flex"
        :style="{ fontSize: `${conf.props.size}${conf.props.unit}`, color: conf.props.color as any }"
    ></div>
</template>

<script lang="ts" setup>
import { onMounted, reactive, ref, watch } from 'vue'

const props = defineProps({
    /**
     * 加载静态资源地址，默认为https://luoye6.c44.cc/vicon
     */
    url: { default: '' },
    /**
     * 使用的图标库名称，默认为'ant'
     */
    lib: { default: '' },
    /**
     * 使用的图标名称，默认为'up'
     */
    name: { default: '' },
    /**
     * 使用的图标大小，默认为'20'
     */
    size: { default: '' as any },
    /**
     * 使用的图标颜色，默认为'currentColor'
     */
    color: { default: '' as any },
    /**
     * 如果为true，使用设计的图标颜色使得color属性无效。默认为false，一般用于多色或固定色图标
     */
    nofill: { default: false },
    /**
     * 图标宽高显示单位，默认为px
     */
    unit: { default: '' }
})

const conf = reactive({
    props: {
        url: '',
        lib: '',
        name: '',
        size: '',
        color: '',
        nofill: '',
        unit: ''
    }
})

const viconConf = VConf.vicon

const loadProps = () => {
    Object.keys(conf.props).forEach((key) => {
        //@ts-ignore
        confObj[key] = StrUtil.isNull(props[key]) ? viconConf[key] : props[key]
    })
}

watch(
    () => [props.name, props.lib, props.color, props.size, props.nofill],
    () => {
        init()
    }
)

onMounted(() => {
    init()
})

const iconRef = ref<HTMLDivElement>({} as any)
const viewBoxStr = '#{viewBox}'
const viewBoxDefault = '0 0 1024 1024'
const str = {
    svg: [
        `<svg style="width: 1em;height: 1em;vertical-align: middle;overflow: hidden;" viewBox="${viewBoxStr}" version="1.1" xmlns="http://www.w3.org/2000/svg">`,
        '</svg>'
    ],
    get0: (replacestr: string) => {
        return str.svg[0].replace(viewBoxStr, replacestr)
    },
    getPath: (param: { d: string; fill?: string }) => {
        return `<path d="${param.d}" fill="${param.fill ?? 'currentColor'}" />`
    }
}

const init = async () => {
    loadProps()
    const color = ['color:black;', 'color:red;']
    if (StrUtil.isNull(conf.props.name)) return
    const _url = `${conf.props.url}/${conf.props.lib}/${conf.props.name}.json`
    const _urlAll = `${conf.props.url}/${conf.props.lib}/_all.json`
    let filestr: any
    let _icon_resource_all = await viconConf.fun.getRes(_urlAll)
    let _icon_resource = await viconConf.fun.getRes(_url)
    if (_icon_resource_all) {
        if (typeof _icon_resource_all === 'string') _icon_resource_all = JSON.parse(_icon_resource_all)
        filestr = _icon_resource_all[conf.props.name]
    } else if (_icon_resource) {
        filestr = _icon_resource
    } else {
        filestr = await viconConf.fun.getResorce(_url, true)
    }
    if (!filestr) {
        console.info(
            `%c icon <%c${conf.props.lib}-${conf.props.name}%c> 不存在`,
            `${color[0]} font-size:12px`,
            color[1],
            color[0]
        )
        return
    }

    if (typeof filestr === 'string') filestr = JSON.parse(filestr)

    let res = ''
    let objt: { d: string[]; fill: { [key: string]: number[] }; viewBox?: string } = filestr
    objt.fill = objt.fill ?? { currentColor: [0] }
    res = str.get0(objt.viewBox ?? viewBoxDefault)
    const getFill = (fill: { [key: string]: number[] }, index: number) => {
        const fillkeys = Object.keys(fill)
        const colors = conf.props.color

        for (let i = 0; i < fillkeys.length; i++) {
            const key = fillkeys[i]
            const nums = fill[key]
            if (nums.includes(index)) {
                if (!conf.props.nofill && colors) {
                    if (Array.isArray(colors)) return colors[i] ?? colors[colors.length - 1]
                    return colors
                } else {
                    return key
                }
            }
        }

        return 'currentColor'
    }

    objt.d.forEach((item, index) => {
        res += str.getPath({
            d: item,
            fill: getFill(objt.fill, index)
        })
    })
    res += str.svg[1]

    if (iconRef.value) iconRef.value.innerHTML = res
}
</script>
